# Values for Loki + Promtail (umbrella chart with two dependencies).
# Loki: monolithic mode, MinIO for storage (dev/small cluster).
# Promtail: DaemonSet, sends logs to Loki.
# Loki service name: loki-gateway (for Grafana datasource URL).

loki:
  # Stable service name for Grafana datasource (http://loki-gateway.monitoring.svc.cluster.local)
  fullnameOverride: "loki"

  # Monolithic mode (single binary, suitable for dev/small cluster)
  deploymentMode: SingleBinary
  singleBinary:
    replicas: 1

  # Zero out other deployment modes
  backend:
    replicas: 0
  read:
    replicas: 0
  write:
    replicas: 0
  ingester:
    replicas: 0
  querier:
    replicas: 0
  queryFrontend:
    replicas: 0
  queryScheduler:
    replicas: 0
  distributor:
    replicas: 0
  compactor:
    replicas: 0
  indexGateway:
    replicas: 0
  bloomCompactor:
    replicas: 0
  bloomGateway:
    replicas: 0

  # Loki config for monolithic single-replica
  loki:
    commonConfig:
      replication_factor: 1
    schemaConfig:
      configs:
        - from: "2024-04-01"
          store: tsdb
          object_store: s3
          schema: v13
          index:
            prefix: loki_index_
            period: 24h
    pattern_ingester:
      enabled: true
    limits_config:
      allow_structured_metadata: true
      volume_enabled: true
    ruler:
      enable_api: true

  # MinIO for object storage (dev/test; for prod use Azure Blob, S3, etc.)
  minio:
    enabled: true

promtail:
  # DaemonSet (default) â€” collects logs from all nodes
  daemonset:
    enabled: true
  deployment:
    enabled: false

  # Loki URL for log shipping (same namespace: monitoring)
  config:
    clients:
      - url: http://loki-gateway.monitoring.svc.cluster.local/loki/api/v1/push

  # ServiceMonitor disabled (template bug in promtail 6.16 with umbrella chart).
  # Prometheus scrapes Promtail via pod annotations below.
  serviceMonitor:
    enabled: false

  # Prometheus scrape via pod annotations (kube-prometheus-stack discovers these)
  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "http-metrics"
    prometheus.io/path: "/metrics"
